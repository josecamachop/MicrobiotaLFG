<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      -->
<title>Ferrer et al. INTESTINAL MICROBIOTA INFLAMMATORY PROFILE IN LATE-FETAL GROWTH RESTRICTION WOMEN, 2025.</title>
<meta name="generator" content="MATLAB 24.2">
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
<meta name="DC.date" content="2025-05-15">
<meta name="DC.source" content="vasca_bac_bio_step2.m">
<style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style>
</head>
<body>
<div class="content">
<h1>Ferrer et al. INTESTINAL MICROBIOTA INFLAMMATORY PROFILE IN LATE-FETAL GROWTH RESTRICTION WOMEN, 2025.</h1>
<!--introduction-->
<p>Script to analyze bacterial data &amp; Inflammatory biomarkers (after outliers removal)</p>
<p>We consider the following model:</p>
<pre class="language-matlab">X = A + B + C(A) + AB + E
</pre>
<p>with A: Class (Control vs IUGR), B: Time (T3, Labour), C(A): Individual</p>
<p>Software preparation: Install MEDA-Toolbox v1.8</p>
<p>coded by: Jose Camacho (<a href="mailto:josecamacho@ugr.es">josecamacho@ugr.es</a>) last modification: 15/May/2025</p>
<p>Copyright (C) 2025 University of Granada, Granada</p>
<p>This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.</p>
<p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</p>
<p>You should have received a copy of the GNU General Public License along with this program. If not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>.</p>
<!--/introduction-->
<h2>Contents</h2>
<div>
<ul>
<li>
<a href="#1">Prepare data</a>
</li>
<li>
<a href="#2">FDR (Q-value)</a>
</li>
<li>
<a href="#3">Compare with after rank tranform (if similar, raw data preferred)</a>
</li>
<li>
<a href="#4">Univariate inference: Q-value with selected features</a>
</li>
<li>
<a href="#5">Multivariate inference: ASCA</a>
</li>
<li>
<a href="#6">Multivariate inference with variable selection: VASCA</a>
</li>
<li>
<a href="#7">Display results: VASCA</a>
</li>
<li>
<a href="#8">Selection of loadings</a>
</li>
</ul>
</div>
<h2 id="1">Prepare data</h2>
<pre class="codeinput">clear
close <span class="string">all</span>
clc

<span class="comment">% comment the line below to observe full randomness</span>
rng(0); <span class="comment">% we fix the random seed for repetitivity, but permutation testing is stochastic so a little variability is expected in the p-values and associated figures</span>

pvalue = 0.05

load <span class="string">bacteria_vasca.mat</span>

X = X_ASCAt;
Xraw = X;
F = F_ASCA;
<span class="keyword">for</span> i=1:length(var_final), var_l{i} = char(var_final(i)); <span class="keyword">end</span>

ind = find(F(:,2)==3);<span class="comment">% do not consider newborns</span>
X(ind,:) = [];
Xraw(ind,:) = [];
F(ind,:) = [];

ind = find(F(:,2)==4);<span class="comment">% do not consider newborns</span>
X(ind,:) = [];
Xraw(ind,:) = [];
F(ind,:) = [];

load <span class="string">biomark_vasca.mat</span>

X2 = X_ASCAt;
Xraw2 = X2;
F2 = F_ASCA;
var_l2 = var_final;

ind = find(F2(:,2)==3);<span class="comment">% do not consider newborns</span>
X2(ind,:) = [];
Xraw2(ind,:) = [];
F2(ind,:) = [];

<span class="comment">% Join</span>
<span class="keyword">for</span> i=length(F2):-1:1
    ind = find(ismember(F,F2(i,:),<span class="string">'rows'</span>));
    <span class="keyword">if</span> isempty(ind)
        X2(i,:) = [];
        Xraw2(i,:) = [];
        F2(i,:) = [];
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">for</span> i=length(F):-1:1
    ind = find(ismember(F2,F(i,:),<span class="string">'rows'</span>));
    <span class="keyword">if</span> isempty(ind)
        X(i,:) = [];
        Xraw(i,:) = [];
        F(i,:) = [];
    <span class="keyword">end</span>
<span class="keyword">end</span>

X = [X X2];
Xraw = [Xraw Xraw2];
var_l = {var_l{:} var_l2{:}};

indout = find(F(:,3)==3); <span class="comment">% Deleting outlier found in first step</span>
X(indout,:) = [];
F(indout,:) = [];

indout = find(F(:,3)==38); <span class="comment">% Deleting outlier found in first step</span>
X(indout,:) = [];
F(indout,:) = [];

Xr =  rankTransform(X);
Xn = X; Xn(find(isnan(X)))=0;
Xrn = X; Xrn(find(isnan(X)))=0;
X = [X Xr]; <span class="comment">% Careful: use [X/norm(Xn) Xr/norm(Xrn)] if not autoscaled</span>

<span class="keyword">for</span> i=1:length(var_l), var_l{end+1} = strcat(var_l{i},<span class="string">'-RT'</span>); <span class="keyword">end</span>

clear <span class="string">X_ASCAt</span> <span class="string">F_ASCA</span> <span class="string">var_final</span> <span class="string">Xr</span> <span class="string">Xn</span> <span class="string">Xrn</span>
</pre>
<pre class="codeoutput">
pvalue =

    0.0500

</pre>
<h2 id="2">FDR (Q-value)</h2>
<pre class="codeinput">[T, parglmoMC] = parglmMC(X, F, <span class="string">'Model'</span>, [1 2], <span class="string">'Mtc'</span>, -1, <span class="string">'Nested'</span>, [1 3], <span class="string">'Random'</span>, [0 0 1]);
T.Source(2:5)={<span class="string">'F1: LFR/Ctrl'</span>,<span class="string">'F2: Time'</span>,<span class="string">'F3: Individual'</span>,<span class="string">'Int Class x Time'</span>}
</pre>
<pre class="codeoutput">
T =

  7&times;7 table

           Source           SumSq     AvPercSumSq    df     MeanSq     MaxF     minPvalue 
    ____________________    ______    ___________    ___    ______    ______    __________

    {'Mean'            }     42540       61.065        1     42540       NaN           NaN
    {'F1: LFR/Ctrl'    }    325.83      0.65048        1    325.83     15.63       0.10033
    {'F2: Time'        }    1253.6       2.7997        1    1253.6    229.24    5.5555e-05
    {'F3: Individual'  }    9687.9       23.935       83    116.72     77.24    2.7778e-05
    {'Int Class x Time'}        77      0.20725        1        77    10.897       0.96674
    {'Residuals'       }    4742.9       11.643       83    57.143       NaN           NaN
    {'Total'           }     58600          100      170    344.71       NaN           NaN

</pre>
<h2 id="3">Compare with after rank tranform (if similar, raw data preferred)</h2>
<pre class="codeinput">half = length(var_l)/2;
noTr = 1:half;
Tr = half+1:2*half;

diff1 = find( (parglmoMC.p(noTr,1)&lt;pvalue | parglmoMC.p(Tr,1)&lt;pvalue) &amp; abs(parglmoMC.p(noTr,1)-parglmoMC.p(Tr,1)) &gt; pvalue);
<span class="keyword">if</span> length(diff1)&gt;0, disp(<span class="string">'Check the following variables in Factor 1:'</span>), <span class="keyword">end</span>
disp(var_l(diff1))

diff2 = find( (parglmoMC.p(noTr,2)&lt;pvalue | parglmoMC.p(Tr,2)&lt;pvalue) &amp; abs(parglmoMC.p(noTr,2)-parglmoMC.p(Tr,2)) &gt; pvalue);
<span class="keyword">if</span> length(diff2)&gt;0, disp(<span class="string">'Check the following variables in Factor 2:'</span>), <span class="keyword">end</span>
disp(var_l(diff2))

diff4 = find( (parglmoMC.p(noTr,4)&lt;pvalue | parglmoMC.p(Tr,4)&lt;pvalue) &amp; abs(parglmoMC.p(noTr,4)-parglmoMC.p(Tr,4)) &gt; pvalue);
<span class="keyword">if</span> length(diff4)&gt;0, disp(<span class="string">'Check the following variables in the Interaction:'</span>), <span class="keyword">end</span>;
disp(var_l(diff4))

X2 = X(:,noTr);
var_l2 = var_l(noTr);

<span class="keyword">if</span> length(diff1)==0 &amp;&amp; length(diff2)==0 &amp;&amp; length(diff4)==0
    disp(<span class="string">'Rank transformation does not make a difference, so we are safe to use the original data.'</span>);
<span class="keyword">else</span>
    disp(<span class="string">'We use the rank tranformation for the Q-value of non-normal variables.'</span>);
    parglmoMC.p(unique([diff1;diff2;diff4]),:) = parglmoMC.p(unique([diff1;diff2;diff4])+half,:);
    X2(:,unique([diff1;diff2;diff4])) = X(:,unique([diff1;diff2;diff4])+half);
    var_l2(unique([diff1;diff2;diff4])) = var_l(unique([diff1;diff2;diff4])+half);
<span class="keyword">end</span>
</pre>
<pre class="codeoutput">Check the following variables in Factor 2:
    {'IL-6'}    {'Resistin'}    {'Adipo/Resis'}

We use the rank tranformation for the Q-value of non-normal variables.
</pre>
<h2 id="4">Univariate inference: Q-value with selected features</h2>
<pre class="codeinput">[T, parglmoMC] = parglmMC(X2, F, <span class="string">'Model'</span>, [1 2], <span class="string">'Mtc'</span>, -1, <span class="string">'Nested'</span>, [1 3], <span class="string">'Random'</span>, [0 0 1]);
T.Source(2:5)={<span class="string">'F1: LFR/Ctrl'</span>,<span class="string">'F2: Time'</span>,<span class="string">'F3: Individual'</span>,<span class="string">'Int LFR/Ctrl x Time'</span>}


TQ = table(var_l2', parglmoMC.p(:,1), parglmoMC.p(:,2), parglmoMC.p(:,4),<span class="string">'VariableNames'</span>, {<span class="string">'Labels'</span>,<span class="string">'QvalueLFRCtrl'</span>,<span class="string">'QvalueTime'</span>,<span class="string">'QvalueInt'</span>})


h=figure; hold <span class="string">on</span>
<span class="keyword">for</span> factor=1:3
    plot(-log10(parglmoMC.p(parglmoMC.ordFactors(factor,:),factor)))
<span class="keyword">end</span>
plot(-log10(parglmoMC.p(parglmoMC.ordInteractions(1,:),4)))
plot([1 size(X2,2)],-log10([pvalue pvalue]),<span class="string">'r--'</span>)
legend(<span class="string">'Factor LFR/Ctrl'</span>,<span class="string">'Factor Time'</span>,<span class="string">'Factor Individual'</span>,<span class="string">'LFR/Ctrl x Time'</span>,<span class="string">'\alpha=0.05'</span>,<span class="string">'Location'</span>,<span class="string">'south'</span>)
a=get(h,<span class="string">'CurrentAxes'</span>);
set(a,<span class="string">'FontSize'</span>,14)
set(a,<span class="string">'YScale'</span>,<span class="string">'log'</span>)
ylabel(<span class="string">'-log_{10}(p-value)'</span>,<span class="string">'FontSize'</span>,18)
xlabel(<span class="string">'Variables in selected order'</span>,<span class="string">'FontSize'</span>,18)
title(<span class="string">'Manhattan Plot Qvalue'</span>)
axis <span class="string">tight</span>

saveas(gcf,<span class="string">'Figures/FigManhattan_Qv_bb'</span>);
saveas(gcf,<span class="string">'Figures/FigManhattan_Qv_bb.jpg'</span>,<span class="string">'jpg'</span>);
saveas(gcf,<span class="string">'Figures/FigManhattan_Qv_bb.png'</span>,<span class="string">'png'</span>);
</pre>
<pre class="codeoutput">
T =

  7&times;7 table

            Source             SumSq     AvPercSumSq    df     MeanSq     MaxF     minPvalue 
    _______________________    ______    ___________    ___    ______    ______    __________

    {'Mean'               }     13145       44.763        1     13145       NaN           NaN
    {'F1: LFR/Ctrl'       }    154.68      0.85678        1    154.68    14.166         0.114
    {'F2: Time'           }    592.06       3.8624        1    592.06     212.4    9.0908e-05
    {'F3: Individual'     }    4898.7       34.649       83    59.021     77.24    5.2631e-05
    {'Int LFR/Ctrl x Time'}    37.825       0.3115        1    37.825    10.897       0.57399
    {'Residuals'          }    2356.7       16.745       83    28.394       NaN           NaN
    {'Total'              }     20946          100      170    123.21       NaN           NaN


TQ =

  59&times;4 table

                    Labels                    QvalueLFRCtrl    QvalueTime    QvalueInt
    ______________________________________    _____________    __________    _________

    {'f-Christensenellaceae;g--'         }       0.43713          0.87282     0.99095 
    {'f-Clostridiaceae;g-Clostridium'    }       0.57328          0.50121     0.97222 
    {'f-Enterobacteriaceae;g--'          }       0.70499          0.23091     0.97222 
    {'f-Erysipelotrichaceae;g--'         }       0.57328          0.50121     0.97222 
    {'f-Lachnospiraceae;g-Clostridium'   }       0.57328          0.50121     0.97222 
    {'f-Lachnospiraceae;g-Ruminococcus'  }       0.38384          0.55036     0.99095 
    {'f-Lachnospiraceae;g-[Ruminococcus]'}       0.57328          0.14954     0.99095 
    {'f-Lachnospiraceae;g--'             }       0.57328          0.55036     0.97222 
    {'f-Pasteurellaceae;g--'             }       0.87361          0.11266     0.81965 
    {'f-Rikenellaceae;g--'               }       0.70499          0.84533      0.9833 
    {'f-Ruminococcaceae;g-Ruminococcus'  }       0.38384          0.55036     0.99095 
    {'f-Ruminococcaceae;g--'             }       0.38384         0.056705     0.97222 
    {'f-[Barnesiellaceae];g--'           }       0.84986          0.67919     0.97222 
    {'g-Actinobacillus'                  }       0.61283          0.56999     0.97222 
    {'g-Akkermansia'                     }       0.38384       9.0908e-05     0.97222 
    {'g-Alistipes'                       }       0.57328       9.0908e-05     0.97222 
    {'g-Anaerostipes'                    }       0.64919       9.0908e-05      0.9833 
    {'g-Bacteroides'                     }       0.61283       9.0908e-05     0.97222 
    {'g-Barnesiella'                     }       0.66665         0.036499     0.97222 
    {'g-Bifidobacterium'                 }       0.66665        0.0038571     0.97222 
    {'g-Bilophila'                       }       0.61283       9.0908e-05     0.97222 
    {'g-Blautia'                         }       0.57328       9.0908e-05     0.97222 
    {'g-Collinsella'                     }       0.57328          0.39723     0.97222 
    {'g-Coprococcus'                     }       0.38384         0.071051     0.57399 
    {'g-Dialister'                       }       0.67658           0.0015      0.9833 
    {'g-Dorea'                           }       0.70499       9.0908e-05     0.99095 
    {'g-Faecalibacterium'                }       0.57328       9.0908e-05     0.97222 
    {'g-Gemmiger'                        }       0.38384       9.0908e-05     0.97222 
    {'g-Kocuria'                         }       0.93588       9.0908e-05     0.97222 
    {'g-Lachnospira'                     }       0.80489           0.4304     0.97222 
    {'g-Odoribacter'                     }       0.57328          0.26825     0.97222 
    {'g-Oscillospira'                    }       0.98163          0.50557     0.99095 
    {'g-Parabacteroides'                 }       0.30299           0.2452     0.97222 
    {'g-Paraprevotella'                  }       0.57328         0.071051     0.97222 
    {'g-Phascolarctobacterium'           }       0.87361            0.172     0.97222 
    {'g-Prevotella'                      }       0.57328           0.4304     0.81965 
    {'g-Pseudomonas'                     }       0.43713          0.90136     0.97222 
    {'g-Roseburia'                       }       0.76483           0.6443     0.97222 
    {'g-Staphylococcus'                  }       0.57328          0.90136     0.99095 
    {'g-Streptococcus'                   }       0.61283          0.67919     0.99095 
    {'g-Subdoligranulum'                 }       0.57328          0.87679     0.97222 
    {'g-Sutterella'                      }       0.38384          0.74668     0.99095 
    {'g-Veillonella'                     }       0.57328          0.87282     0.97222 
    {'o-Clostridiales;f-;g--'            }       0.57328          0.67919     0.97222 
    {'o-RF;f-;g--'                       }       0.57328          0.67919     0.97222 
    {'RARRESS'                           }       0.57328          0.50121     0.97222 
    {'LBP'                               }         0.114          0.35596     0.97222 
    {'IFN-G'                             }       0.30299          0.60006     0.97222 
    {'IL-10'                             }       0.38384       9.0908e-05     0.97222 
    {'IL-23'                             }       0.70499          0.90136     0.97222 
    {'IL-6-RT'                           }       0.70871        0.0028461     0.97222 
    {'IL-8'                              }       0.70499          0.67919     0.97222 
    {'Adiponectin'                       }        0.1325          0.39723     0.97222 
    {'Resistin-RT'                       }       0.30299         0.093148     0.97222 
    {'IL-15'                             }       0.91872          0.70342      0.9833 
    {'VEGF'                              }       0.84986          0.60588     0.97222 
    {'Leptin'                            }       0.57328          0.25757     0.97222 
    {'Adipo/Lep'                         }       0.70499          0.50121     0.97222 
    {'Adipo/Resis-RT'                    }       0.70499        0.0083999     0.97222 

</pre>
<img vspace="5" hspace="5" src="vasca_bac_bio_step2_01.png" alt=""> <h2 id="5">Multivariate inference: ASCA</h2>
<pre class="codeinput">[T, parglmo] = parglm(X2, F, <span class="string">'Model'</span>, [1 2], <span class="string">'Nested'</span>, [1 3], <span class="string">'Random'</span>, [0 0 1]);
T.Source(2:5)={<span class="string">'F1: LFR/Ctrl'</span>,<span class="string">'F2: Time'</span>,<span class="string">'F3: Individual'</span>,<span class="string">'Int LFR/Ctrl x Time'</span>}
</pre>
<pre class="codeoutput">
T =

  7&times;7 table

            Source             SumSq     PercSumSq    df     MeanSq      F        Pvalue 
    _______________________    ______    _________    ___    ______    ______    ________

    {'Mean'               }     13145      62.756       1     13145       NaN         NaN
    {'F1: LFR/Ctrl'       }    154.68     0.73845       1    154.68    2.6207    0.018981
    {'F2: Time'           }    592.06      2.8266       1    592.06    20.852    0.000999
    {'F3: Individual'     }    4898.7      23.387      83    59.021    2.0786    0.000999
    {'Int LFR/Ctrl x Time'}    37.825     0.18058       1    37.825    1.3321      0.7013
    {'Residuals'          }    2356.7      11.251      83    28.394       NaN         NaN
    {'Total'              }     20946         100     170    123.21       NaN         NaN

</pre>
<h2 id="6">Multivariate inference with variable selection: VASCA</h2>
<pre class="codeinput">[T, parglmoVS] = parglmVS(X2, F, <span class="string">'Model'</span>, [1 2], <span class="string">'Nested'</span>, [1 3], <span class="string">'Random'</span>, [0 0 1]);
T.Source(2:5)={<span class="string">'F1: LFR/Ctrl'</span>,<span class="string">'F2: Time'</span>,<span class="string">'F3: Individual'</span>,<span class="string">'Int LFR/Ctrl x Time'</span>}

TtQ = table(var_l2', parglmoVS.p(:,1), parglmoVS.p(:,2), parglmoVS.p(:,4),<span class="string">'VariableNames'</span>, {<span class="string">'Labels'</span>,<span class="string">'VASCALFRCtrl'</span>,<span class="string">'VASCATime'</span>,<span class="string">'VASCAInt'</span>})

h=figure; hold <span class="string">on</span>
<span class="keyword">for</span> factor=1:3
    plot(-log10(parglmoVS.p(parglmoVS.ordFactors(factor,:),factor)))
<span class="keyword">end</span>
plot(-log10(parglmoVS.p(parglmoVS.ordInteractions(1,:),4)))
plot([1 size(X2,2)],-log10([pvalue pvalue]),<span class="string">'r--'</span>)
legend(<span class="string">'Factor LFR/Ctrl'</span>,<span class="string">'Factor Time'</span>,<span class="string">'Factor Individual'</span>,<span class="string">'LFR/Ctrl x Time'</span>,<span class="string">'\alpha=0.05'</span>,<span class="string">'Location'</span>,<span class="string">'south'</span>)
a=get(h,<span class="string">'CurrentAxes'</span>);
set(a,<span class="string">'FontSize'</span>,14)
set(a,<span class="string">'YScale'</span>,<span class="string">'log'</span>)
ylabel(<span class="string">'-log_{10}(p-value)'</span>,<span class="string">'FontSize'</span>,18)
xlabel(<span class="string">'Variables in selected order'</span>,<span class="string">'FontSize'</span>,18)
title(<span class="string">'Manhattan Plot vASCA'</span>)
axis <span class="string">tight</span>

saveas(gcf,<span class="string">'Figures/FigManhattan_bb'</span>);
saveas(gcf,<span class="string">'Figures/FigManhattan_bb.jpg'</span>,<span class="string">'jpg'</span>);
saveas(gcf,<span class="string">'Figures/FigManhattan_bb.png'</span>,<span class="string">'png'</span>);
</pre>
<pre class="codeoutput">
T =

  7&times;7 table

            Source             SumSq     AvPercSumSq    df     MeanSq     MaxF     minPvalue
    _______________________    ______    ___________    ___    ______    ______    _________

    {'Mean'               }     13145       44.763        1     13145       NaN         NaN 
    {'F1: LFR/Ctrl'       }    154.68      0.85678        1    154.68    14.166    0.018981 
    {'F2: Time'           }    592.06       3.8624        1    592.06     212.4    0.000999 
    {'F3: Individual'     }    4898.7       34.649       83    59.021     77.24    0.000999 
    {'Int LFR/Ctrl x Time'}    37.825       0.3115        1    37.825    10.897     0.37163 
    {'Residuals'          }    2356.7       16.745       83    28.394       NaN         NaN 
    {'Total'              }     20946          100      170    123.21       NaN         NaN 


TtQ =

  59&times;4 table

                    Labels                    VASCALFRCtrl    VASCATime    VASCAInt
    ______________________________________    ____________    _________    ________

    {'f-Christensenellaceae;g--'         }      0.057942      0.000999     0.69231 
    {'f-Clostridiaceae;g-Clostridium'    }      0.048951      0.000999     0.58442 
    {'f-Enterobacteriaceae;g--'          }      0.020979      0.000999     0.73626 
    {'f-Erysipelotrichaceae;g--'         }      0.048951      0.000999     0.70529 
    {'f-Lachnospiraceae;g-Clostridium'   }       0.04995      0.000999     0.58042 
    {'f-Lachnospiraceae;g-Ruminococcus'  }      0.074925      0.000999     0.67033 
    {'f-Lachnospiraceae;g-[Ruminococcus]'}      0.037962      0.000999      0.6963 
    {'f-Lachnospiraceae;g--'             }      0.035964      0.000999      0.6973 
    {'f-Pasteurellaceae;g--'             }      0.020979      0.000999     0.43157 
    {'f-Rikenellaceae;g--'               }      0.020979      0.000999     0.69431 
    {'f-Ruminococcaceae;g-Ruminococcus'  }      0.070929      0.000999     0.67732 
    {'f-Ruminococcaceae;g--'             }      0.076923      0.000999     0.71628 
    {'f-[Barnesiellaceae];g--'           }       0.01998      0.000999     0.71728 
    {'g-Actinobacillus'                  }      0.036963      0.000999      0.4975 
    {'g-Akkermansia'                     }      0.062937      0.000999     0.70829 
    {'g-Alistipes'                       }      0.042957      0.000999     0.72527 
    {'g-Anaerostipes'                    }      0.026973      0.000999      0.6953 
    {'g-Bacteroides'                     }      0.030969      0.000999     0.70829 
    {'g-Barnesiella'                     }      0.025974      0.000999     0.63536 
    {'g-Bifidobacterium'                 }      0.024975      0.000999     0.58442 
    {'g-Bilophila'                       }       0.02997      0.000999      0.6004 
    {'g-Blautia'                         }       0.03996      0.000999     0.70929 
    {'g-Collinsella'                     }      0.043956      0.000999     0.45954 
    {'g-Coprococcus'                     }       0.08991      0.000999     0.43856 
    {'g-Dialister'                       }      0.022977      0.000999      0.7023 
    {'g-Dorea'                           }      0.021978      0.000999     0.68232 
    {'g-Faecalibacterium'                }      0.048951      0.000999     0.72827 
    {'g-Gemmiger'                        }      0.056943      0.000999     0.51548 
    {'g-Kocuria'                         }      0.018981      0.000999     0.71429 
    {'g-Lachnospira'                     }      0.020979      0.000999     0.68032 
    {'g-Odoribacter'                     }      0.047952      0.000999     0.71329 
    {'g-Oscillospira'                    }       0.01998      0.000999     0.68731 
    {'g-Parabacteroides'                 }       0.12388      0.000999     0.53646 
    {'g-Paraprevotella'                  }      0.036963      0.000999     0.71928 
    {'g-Phascolarctobacterium'           }      0.020979      0.000999      0.7013 
    {'g-Prevotella'                      }      0.046953      0.000999     0.37163 
    {'g-Pseudomonas'                     }      0.052947      0.000999     0.73027 
    {'g-Roseburia'                       }      0.020979      0.000999     0.72128 
    {'g-Staphylococcus'                  }      0.047952      0.000999      0.7013 
    {'g-Streptococcus'                   }       0.02997      0.000999     0.69431 
    {'g-Subdoligranulum'                 }      0.043956      0.000999     0.69331 
    {'g-Sutterella'                      }      0.080919      0.000999      0.6983 
    {'g-Veillonella'                     }      0.036963      0.000999     0.71928 
    {'o-Clostridiales;f-;g--'            }      0.047952      0.000999     0.69231 
    {'o-RF;f-;g--'                       }      0.041958      0.000999     0.54645 
    {'RARRESS'                           }      0.043956      0.000999      0.6963 
    {'LBP'                               }        0.2008      0.000999      0.7033 
    {'IFN-G'                             }       0.10889      0.000999     0.68731 
    {'IL-10'                             }       0.10889      0.000999     0.51449 
    {'IL-23'                             }      0.020979      0.000999     0.68731 
    {'IL-6-RT'                           }      0.020979      0.000999     0.68931 
    {'IL-8'                              }       0.01998      0.000999     0.56144 
    {'Adiponectin'                       }       0.13087      0.000999     0.51748 
    {'Resistin-RT'                       }       0.11888      0.000999     0.69131 
    {'IL-15'                             }      0.021978      0.000999     0.66434 
    {'VEGF'                              }      0.018981      0.000999     0.70729 
    {'Leptin'                            }      0.041958      0.000999      0.7023 
    {'Adipo/Lep'                         }      0.022977      0.000999     0.70629 
    {'Adipo/Resis-RT'                    }      0.022977      0.000999      0.6963 

</pre>
<img vspace="5" hspace="5" src="vasca_bac_bio_step2_02.png" alt=""> <h2 id="7">Display results: VASCA</h2>
<pre class="codeinput">vascao = vasca(parglmoVS, pvalue);


<span class="comment">% LFR/Ctrl factor</span>

i=1;
<span class="keyword">if</span> isfield(vascao.factors{i},<span class="string">'scores'</span>)

    TvASCA = table((1:length(vascao.factors{i}.ind))',var_l2(sort(vascao.factors{i}.ind))', vascao.p(sort(vascao.factors{i}.ind),i),<span class="string">'VariableNames'</span>, {<span class="string">'Order'</span>,<span class="string">'Label'</span>,sprintf(<span class="string">'PvalueF%i'</span>,i)})

    scores(vascao.factors{i}, <span class="string">'Title'</span>, <span class="string">'Case/control'</span>, <span class="string">'ObsClass'</span>, vascao.design(:,i));
    legend(<span class="string">'Control'</span>, <span class="string">'LFG'</span>);

    <span class="keyword">if</span> length(vascao.factors{i}.ind)==1
        ylabel(var_l2(vascao.factors{i}.ind))
    <span class="keyword">else</span>
        loadings(vascao.factors{i}, <span class="string">'Title'</span>,<span class="string">'Case/control'</span>,<span class="string">'VarsLabel'</span>, var_l2(sort(vascao.factors{i}.ind)));
    <span class="keyword">end</span>

<span class="keyword">end</span>


<span class="comment">% Time Factor</span>

i=2;
<span class="keyword">if</span> isfield(vascao.factors{i},<span class="string">'scores'</span>)

    TvASCA = table((1:length(vascao.factors{i}.ind))',var_l2(sort(vascao.factors{i}.ind))', vascao.p(sort(vascao.factors{i}.ind),i),<span class="string">'VariableNames'</span>, {<span class="string">'Order'</span>,<span class="string">'Label'</span>,sprintf(<span class="string">'PvalueF%i'</span>,i)})

    vascao.factors{i}.loads = -vascao.factors{i}.loads;
    vascao.factors{i}.scoresV = -vascao.factors{i}.scoresV;

    scores(vascao.factors{i}, <span class="string">'Title'</span>, <span class="string">'Time'</span>, <span class="string">'ObsClass'</span>,vascao.design(:,i));
    legend(<span class="string">'T3'</span>, <span class="string">'Labour'</span>);

    <span class="keyword">if</span> length(vascao.factors{i}.ind)==1
        ylabel(var_l2(vascao.factors{i}.ind))
    <span class="keyword">else</span>
        loadings(vascao.factors{i}, <span class="string">'Title'</span>,<span class="string">'Time'</span>, <span class="string">'VarsLabel'</span>, var_l2(sort(vascao.factors{i}.ind)));
    <span class="keyword">end</span>

<span class="keyword">end</span>


<span class="comment">% Factor Individual</span>

i=3;
<span class="keyword">if</span> isfield(vascao.factors{i},<span class="string">'scores'</span>)

    TvASCA = table((1:length(vascao.factors{i}.ind))',var_l2(sort(vascao.factors{i}.ind))', vascao.p(sort(vascao.factors{i}.ind),i),<span class="string">'VariableNames'</span>, {<span class="string">'Order'</span>,<span class="string">'Label'</span>,sprintf(<span class="string">'PvalueF%i'</span>,i)})

    <span class="keyword">if</span> vascao.factors{i}.stasig
        varPca(vascao.factors{i}.matrix);
        mspcPca(vascao.factors{i}.matrix, <span class="string">'PCs'</span>, 1:2, <span class="string">'ObsTest'</span>, vascao.factors{i}.matrix+vascao.residuals, <span class="string">'PlotCal'</span>, false, <span class="string">'ObsLabel'</span>, vascao.design(:,3), <span class="string">'ObsClass'</span>, vascao.design(:,1), <span class="string">'LimType'</span>, 1);
        title(sprintf(<span class="string">'Factor %d'</span>,i));
        legend(<span class="string">'Control'</span>, <span class="string">'LFG'</span>);

    <span class="keyword">end</span>
<span class="keyword">end</span>


<span class="comment">% 'Case/control' x 'Time'</span>

i=1;
<span class="keyword">if</span> isfield(vascao.interactions{i},<span class="string">'scores'</span>)

    TvASCA = table((1:length(vascao.interactions{i}.ind))',var_l2(sort(vascao.interactions{i}.ind))', vascao.p(sort(vascao.interactions{i}.ind),3+i),<span class="string">'VariableNames'</span>, {<span class="string">'Order'</span>,<span class="string">'Label'</span>,sprintf(<span class="string">'PvalueI%i'</span>,i)})

    scores(vascao.interactions{i}, <span class="string">'Title'</span>, <span class="string">'Int LFR/Ctrl x Time'</span>, <span class="string">'ObsClass'</span>, vascao.design(:,1)*10+vascao.design(:,2));
    legend(<span class="string">'Ctrl+T3'</span>,<span class="string">'Case+T3'</span>,<span class="string">'Ctrl+Labour'</span>,<span class="string">'Case+Labour'</span>);

    <span class="keyword">if</span> length(vascao.interactions{i}.ind)==1
        ylabel(var_l2(vascao.interactions{i}.ind))
    <span class="keyword">else</span>
        loadings(model,<span class="string">'Title'</span>, <span class="string">'Int LFR/Ctrl x Time'</span>, <span class="string">'VarsLabel'</span>, var_l2(sort(vascao.interactions{i}.ind)));
    <span class="keyword">end</span>

<span class="keyword">end</span>
</pre>
<pre class="codeoutput">
TvASCA =

  59&times;3 table

    Order                    Label                     PvalueF1
    _____    ______________________________________    ________

      1      {'f-Christensenellaceae;g--'         }    0.057942
      2      {'f-Clostridiaceae;g-Clostridium'    }    0.048951
      3      {'f-Enterobacteriaceae;g--'          }    0.020979
      4      {'f-Erysipelotrichaceae;g--'         }    0.048951
      5      {'f-Lachnospiraceae;g-Clostridium'   }     0.04995
      6      {'f-Lachnospiraceae;g-Ruminococcus'  }    0.074925
      7      {'f-Lachnospiraceae;g-[Ruminococcus]'}    0.037962
      8      {'f-Lachnospiraceae;g--'             }    0.035964
      9      {'f-Pasteurellaceae;g--'             }    0.020979
     10      {'f-Rikenellaceae;g--'               }    0.020979
     11      {'f-Ruminococcaceae;g-Ruminococcus'  }    0.070929
     12      {'f-Ruminococcaceae;g--'             }    0.076923
     13      {'f-[Barnesiellaceae];g--'           }     0.01998
     14      {'g-Actinobacillus'                  }    0.036963
     15      {'g-Akkermansia'                     }    0.062937
     16      {'g-Alistipes'                       }    0.042957
     17      {'g-Anaerostipes'                    }    0.026973
     18      {'g-Bacteroides'                     }    0.030969
     19      {'g-Barnesiella'                     }    0.025974
     20      {'g-Bifidobacterium'                 }    0.024975
     21      {'g-Bilophila'                       }     0.02997
     22      {'g-Blautia'                         }     0.03996
     23      {'g-Collinsella'                     }    0.043956
     24      {'g-Coprococcus'                     }     0.08991
     25      {'g-Dialister'                       }    0.022977
     26      {'g-Dorea'                           }    0.021978
     27      {'g-Faecalibacterium'                }    0.048951
     28      {'g-Gemmiger'                        }    0.056943
     29      {'g-Kocuria'                         }    0.018981
     30      {'g-Lachnospira'                     }    0.020979
     31      {'g-Odoribacter'                     }    0.047952
     32      {'g-Oscillospira'                    }     0.01998
     33      {'g-Parabacteroides'                 }     0.12388
     34      {'g-Paraprevotella'                  }    0.036963
     35      {'g-Phascolarctobacterium'           }    0.020979
     36      {'g-Prevotella'                      }    0.046953
     37      {'g-Pseudomonas'                     }    0.052947
     38      {'g-Roseburia'                       }    0.020979
     39      {'g-Staphylococcus'                  }    0.047952
     40      {'g-Streptococcus'                   }     0.02997
     41      {'g-Subdoligranulum'                 }    0.043956
     42      {'g-Sutterella'                      }    0.080919
     43      {'g-Veillonella'                     }    0.036963
     44      {'o-Clostridiales;f-;g--'            }    0.047952
     45      {'o-RF;f-;g--'                       }    0.041958
     46      {'RARRESS'                           }    0.043956
     47      {'LBP'                               }      0.2008
     48      {'IFN-G'                             }     0.10889
     49      {'IL-10'                             }     0.10889
     50      {'IL-23'                             }    0.020979
     51      {'IL-6-RT'                           }    0.020979
     52      {'IL-8'                              }     0.01998
     53      {'Adiponectin'                       }     0.13087
     54      {'Resistin-RT'                       }     0.11888
     55      {'IL-15'                             }    0.021978
     56      {'VEGF'                              }    0.018981
     57      {'Leptin'                            }    0.041958
     58      {'Adipo/Lep'                         }    0.022977
     59      {'Adipo/Resis-RT'                    }    0.022977


TvASCA =

  59&times;3 table

    Order                    Label                     PvalueF2
    _____    ______________________________________    ________

      1      {'f-Christensenellaceae;g--'         }    0.000999
      2      {'f-Clostridiaceae;g-Clostridium'    }    0.000999
      3      {'f-Enterobacteriaceae;g--'          }    0.000999
      4      {'f-Erysipelotrichaceae;g--'         }    0.000999
      5      {'f-Lachnospiraceae;g-Clostridium'   }    0.000999
      6      {'f-Lachnospiraceae;g-Ruminococcus'  }    0.000999
      7      {'f-Lachnospiraceae;g-[Ruminococcus]'}    0.000999
      8      {'f-Lachnospiraceae;g--'             }    0.000999
      9      {'f-Pasteurellaceae;g--'             }    0.000999
     10      {'f-Rikenellaceae;g--'               }    0.000999
     11      {'f-Ruminococcaceae;g-Ruminococcus'  }    0.000999
     12      {'f-Ruminococcaceae;g--'             }    0.000999
     13      {'f-[Barnesiellaceae];g--'           }    0.000999
     14      {'g-Actinobacillus'                  }    0.000999
     15      {'g-Akkermansia'                     }    0.000999
     16      {'g-Alistipes'                       }    0.000999
     17      {'g-Anaerostipes'                    }    0.000999
     18      {'g-Bacteroides'                     }    0.000999
     19      {'g-Barnesiella'                     }    0.000999
     20      {'g-Bifidobacterium'                 }    0.000999
     21      {'g-Bilophila'                       }    0.000999
     22      {'g-Blautia'                         }    0.000999
     23      {'g-Collinsella'                     }    0.000999
     24      {'g-Coprococcus'                     }    0.000999
     25      {'g-Dialister'                       }    0.000999
     26      {'g-Dorea'                           }    0.000999
     27      {'g-Faecalibacterium'                }    0.000999
     28      {'g-Gemmiger'                        }    0.000999
     29      {'g-Kocuria'                         }    0.000999
     30      {'g-Lachnospira'                     }    0.000999
     31      {'g-Odoribacter'                     }    0.000999
     32      {'g-Oscillospira'                    }    0.000999
     33      {'g-Parabacteroides'                 }    0.000999
     34      {'g-Paraprevotella'                  }    0.000999
     35      {'g-Phascolarctobacterium'           }    0.000999
     36      {'g-Prevotella'                      }    0.000999
     37      {'g-Pseudomonas'                     }    0.000999
     38      {'g-Roseburia'                       }    0.000999
     39      {'g-Staphylococcus'                  }    0.000999
     40      {'g-Streptococcus'                   }    0.000999
     41      {'g-Subdoligranulum'                 }    0.000999
     42      {'g-Sutterella'                      }    0.000999
     43      {'g-Veillonella'                     }    0.000999
     44      {'o-Clostridiales;f-;g--'            }    0.000999
     45      {'o-RF;f-;g--'                       }    0.000999
     46      {'RARRESS'                           }    0.000999
     47      {'LBP'                               }    0.000999
     48      {'IFN-G'                             }    0.000999
     49      {'IL-10'                             }    0.000999
     50      {'IL-23'                             }    0.000999
     51      {'IL-6-RT'                           }    0.000999
     52      {'IL-8'                              }    0.000999
     53      {'Adiponectin'                       }    0.000999
     54      {'Resistin-RT'                       }    0.000999
     55      {'IL-15'                             }    0.000999
     56      {'VEGF'                              }    0.000999
     57      {'Leptin'                            }    0.000999
     58      {'Adipo/Lep'                         }    0.000999
     59      {'Adipo/Resis-RT'                    }    0.000999


TvASCA =

  59&times;3 table

    Order                    Label                     PvalueF3
    _____    ______________________________________    ________

      1      {'f-Christensenellaceae;g--'         }    0.000999
      2      {'f-Clostridiaceae;g-Clostridium'    }    0.000999
      3      {'f-Enterobacteriaceae;g--'          }    0.000999
      4      {'f-Erysipelotrichaceae;g--'         }    0.000999
      5      {'f-Lachnospiraceae;g-Clostridium'   }    0.000999
      6      {'f-Lachnospiraceae;g-Ruminococcus'  }    0.000999
      7      {'f-Lachnospiraceae;g-[Ruminococcus]'}    0.000999
      8      {'f-Lachnospiraceae;g--'             }    0.000999
      9      {'f-Pasteurellaceae;g--'             }    0.000999
     10      {'f-Rikenellaceae;g--'               }    0.000999
     11      {'f-Ruminococcaceae;g-Ruminococcus'  }    0.000999
     12      {'f-Ruminococcaceae;g--'             }    0.000999
     13      {'f-[Barnesiellaceae];g--'           }    0.000999
     14      {'g-Actinobacillus'                  }    0.000999
     15      {'g-Akkermansia'                     }    0.000999
     16      {'g-Alistipes'                       }    0.000999
     17      {'g-Anaerostipes'                    }    0.000999
     18      {'g-Bacteroides'                     }    0.000999
     19      {'g-Barnesiella'                     }    0.000999
     20      {'g-Bifidobacterium'                 }    0.000999
     21      {'g-Bilophila'                       }    0.000999
     22      {'g-Blautia'                         }    0.000999
     23      {'g-Collinsella'                     }    0.000999
     24      {'g-Coprococcus'                     }    0.000999
     25      {'g-Dialister'                       }    0.000999
     26      {'g-Dorea'                           }    0.000999
     27      {'g-Faecalibacterium'                }    0.000999
     28      {'g-Gemmiger'                        }    0.000999
     29      {'g-Kocuria'                         }    0.000999
     30      {'g-Lachnospira'                     }    0.000999
     31      {'g-Odoribacter'                     }    0.000999
     32      {'g-Oscillospira'                    }    0.000999
     33      {'g-Parabacteroides'                 }    0.000999
     34      {'g-Paraprevotella'                  }    0.000999
     35      {'g-Phascolarctobacterium'           }    0.000999
     36      {'g-Prevotella'                      }    0.000999
     37      {'g-Pseudomonas'                     }    0.000999
     38      {'g-Roseburia'                       }    0.000999
     39      {'g-Staphylococcus'                  }    0.000999
     40      {'g-Streptococcus'                   }    0.000999
     41      {'g-Subdoligranulum'                 }    0.000999
     42      {'g-Sutterella'                      }    0.000999
     43      {'g-Veillonella'                     }    0.000999
     44      {'o-Clostridiales;f-;g--'            }    0.000999
     45      {'o-RF;f-;g--'                       }    0.000999
     46      {'RARRESS'                           }    0.000999
     47      {'LBP'                               }    0.000999
     48      {'IFN-G'                             }    0.000999
     49      {'IL-10'                             }    0.000999
     50      {'IL-23'                             }    0.000999
     51      {'IL-6-RT'                           }    0.000999
     52      {'IL-8'                              }    0.000999
     53      {'Adiponectin'                       }    0.000999
     54      {'Resistin-RT'                       }    0.000999
     55      {'IL-15'                             }    0.000999
     56      {'VEGF'                              }    0.000999
     57      {'Leptin'                            }    0.000999
     58      {'Adipo/Lep'                         }    0.000999
     59      {'Adipo/Resis-RT'                    }    0.000999

</pre>
<img vspace="5" hspace="5" src="vasca_bac_bio_step2_03.png" alt=""> <img vspace="5" hspace="5" src="vasca_bac_bio_step2_04.png" alt=""> <img vspace="5" hspace="5" src="vasca_bac_bio_step2_05.png" alt=""> <img vspace="5" hspace="5" src="vasca_bac_bio_step2_06.png" alt=""> <img vspace="5" hspace="5" src="vasca_bac_bio_step2_07.png" alt=""> <img vspace="5" hspace="5" src="vasca_bac_bio_step2_08.png" alt=""> <h2 id="8">Selection of loadings</h2>
<pre class="codeinput">indS = find(abs(vascao.factors{1}.loads)&gt;0.2);
ind2 = sort(vascao.factors{i}.ind);
plotVec(vascao.factors{1}.loads(indS),<span class="string">'EleLabel'</span>, var_l2(ind2(indS)));
title(<span class="string">'Case/control: Highest loadings'</span>)

saveas(gcf,<span class="string">'Figures/FigHL_bb'</span>);
saveas(gcf,<span class="string">'Figures/FigHL_bb.jpg'</span>,<span class="string">'jpg'</span>);
saveas(gcf,<span class="string">'Figures/FigHL_bb.png'</span>,<span class="string">'png'</span>);
</pre>
<img vspace="5" hspace="5" src="vasca_bac_bio_step2_09.png" alt=""> <p class="footer">
<br>
<a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2024b</a>
<br>
</p>
</div>
<!--
##### SOURCE BEGIN #####
%% Ferrer et al. INTESTINAL MICROBIOTA INFLAMMATORY PROFILE IN LATE-FETAL GROWTH RESTRICTION WOMEN, 2025. 
% Script to analyze bacterial data & Inflammatory biomarkers  (after outliers removal)
%
% We consider the following model: 
%
%   X = A + B + C(A) + AB + E
%
% with A: Class (Control vs IUGR), B: Time (T3, Labour), C(A): Individual
%
% Software preparation: Install MEDA-Toolbox v1.8
%
% coded by: Jose Camacho (josecamacho@ugr.es)
% last modification: 15/May/2025
%
% Copyright (C) 2025  University of Granada, Granada
% 
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
% 
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.

%% Prepare data

clear
close all
clc

% comment the line below to observe full randomness
rng(0); % we fix the random seed for repetitivity, but permutation testing is stochastic so a little variability is expected in the p-values and associated figures

pvalue = 0.05

load bacteria_vasca.mat

X = X_ASCAt;
Xraw = X;
F = F_ASCA;
for i=1:length(var_final), var_l{i} = char(var_final(i)); end

ind = find(F(:,2)==3);% do not consider newborns
X(ind,:) = [];
Xraw(ind,:) = [];
F(ind,:) = [];

ind = find(F(:,2)==4);% do not consider newborns
X(ind,:) = [];
Xraw(ind,:) = [];
F(ind,:) = [];

load biomark_vasca.mat

X2 = X_ASCAt;
Xraw2 = X2;
F2 = F_ASCA;
var_l2 = var_final;

ind = find(F2(:,2)==3);% do not consider newborns
X2(ind,:) = [];
Xraw2(ind,:) = [];
F2(ind,:) = [];

% Join
for i=length(F2):-1:1
    ind = find(ismember(F,F2(i,:),'rows'));
    if isempty(ind)
        X2(i,:) = [];
        Xraw2(i,:) = [];
        F2(i,:) = [];
    end
end

for i=length(F):-1:1
    ind = find(ismember(F2,F(i,:),'rows'));
    if isempty(ind)
        X(i,:) = [];
        Xraw(i,:) = [];
        F(i,:) = [];
    end
end

X = [X X2];
Xraw = [Xraw Xraw2];
var_l = {var_l{:} var_l2{:}};

indout = find(F(:,3)==3); % Deleting outlier found in first step
X(indout,:) = [];
F(indout,:) = [];

indout = find(F(:,3)==38); % Deleting outlier found in first step
X(indout,:) = [];
F(indout,:) = [];

Xr =  rankTransform(X);
Xn = X; Xn(find(isnan(X)))=0;
Xrn = X; Xrn(find(isnan(X)))=0; 
X = [X Xr]; % Careful: use [X/norm(Xn) Xr/norm(Xrn)] if not autoscaled

for i=1:length(var_l), var_l{end+1} = strcat(var_l{i},'-RT'); end

clear X_ASCAt F_ASCA var_final Xr Xn Xrn

%% FDR (Q-value)

[T, parglmoMC] = parglmMC(X, F, 'Model', [1 2], 'Mtc', -1, 'Nested', [1 3], 'Random', [0 0 1]);
T.Source(2:5)={'F1: LFR/Ctrl','F2: Time','F3: Individual','Int Class x Time'}
       

%% Compare with after rank tranform (if similar, raw data preferred) 

half = length(var_l)/2;
noTr = 1:half;
Tr = half+1:2*half;

diff1 = find( (parglmoMC.p(noTr,1)<pvalue | parglmoMC.p(Tr,1)<pvalue) & abs(parglmoMC.p(noTr,1)-parglmoMC.p(Tr,1)) > pvalue);
if length(diff1)>0, disp('Check the following variables in Factor 1:'), end
disp(var_l(diff1))

diff2 = find( (parglmoMC.p(noTr,2)<pvalue | parglmoMC.p(Tr,2)<pvalue) & abs(parglmoMC.p(noTr,2)-parglmoMC.p(Tr,2)) > pvalue);
if length(diff2)>0, disp('Check the following variables in Factor 2:'), end
disp(var_l(diff2))

diff4 = find( (parglmoMC.p(noTr,4)<pvalue | parglmoMC.p(Tr,4)<pvalue) & abs(parglmoMC.p(noTr,4)-parglmoMC.p(Tr,4)) > pvalue);
if length(diff4)>0, disp('Check the following variables in the Interaction:'), end;
disp(var_l(diff4))

X2 = X(:,noTr);
var_l2 = var_l(noTr);
    
if length(diff1)==0 && length(diff2)==0 && length(diff4)==0 
    disp('Rank transformation does not make a difference, so we are safe to use the original data.'); 
else
    disp('We use the rank tranformation for the Q-value of non-normal variables.');
    parglmoMC.p(unique([diff1;diff2;diff4]),:) = parglmoMC.p(unique([diff1;diff2;diff4])+half,:);
    X2(:,unique([diff1;diff2;diff4])) = X(:,unique([diff1;diff2;diff4])+half);
    var_l2(unique([diff1;diff2;diff4])) = var_l(unique([diff1;diff2;diff4])+half);
end


%% Univariate inference: Q-value with selected features

[T, parglmoMC] = parglmMC(X2, F, 'Model', [1 2], 'Mtc', -1, 'Nested', [1 3], 'Random', [0 0 1]);
T.Source(2:5)={'F1: LFR/Ctrl','F2: Time','F3: Individual','Int LFR/Ctrl x Time'}


TQ = table(var_l2', parglmoMC.p(:,1), parglmoMC.p(:,2), parglmoMC.p(:,4),'VariableNames', {'Labels','QvalueLFRCtrl','QvalueTime','QvalueInt'})


h=figure; hold on
for factor=1:3
    plot(-log10(parglmoMC.p(parglmoMC.ordFactors(factor,:),factor)))
end
plot(-log10(parglmoMC.p(parglmoMC.ordInteractions(1,:),4)))
plot([1 size(X2,2)],-log10([pvalue pvalue]),'rREPLACE_WITH_DASH_DASH')
legend('Factor LFR/Ctrl','Factor Time','Factor Individual','LFR/Ctrl x Time','\alpha=0.05','Location','south')
a=get(h,'CurrentAxes');
set(a,'FontSize',14)
set(a,'YScale','log')
ylabel('-log_{10}(p-value)','FontSize',18)
xlabel('Variables in selected order','FontSize',18)
title('Manhattan Plot Qvalue')
axis tight

saveas(gcf,'Figures/FigManhattan_Qv_bb');
saveas(gcf,'Figures/FigManhattan_Qv_bb.jpg','jpg');
saveas(gcf,'Figures/FigManhattan_Qv_bb.png','png');


%% Multivariate inference: ASCA 

[T, parglmo] = parglm(X2, F, 'Model', [1 2], 'Nested', [1 3], 'Random', [0 0 1]);
T.Source(2:5)={'F1: LFR/Ctrl','F2: Time','F3: Individual','Int LFR/Ctrl x Time'}

%% Multivariate inference with variable selection: VASCA 

[T, parglmoVS] = parglmVS(X2, F, 'Model', [1 2], 'Nested', [1 3], 'Random', [0 0 1]);
T.Source(2:5)={'F1: LFR/Ctrl','F2: Time','F3: Individual','Int LFR/Ctrl x Time'}

TtQ = table(var_l2', parglmoVS.p(:,1), parglmoVS.p(:,2), parglmoVS.p(:,4),'VariableNames', {'Labels','VASCALFRCtrl','VASCATime','VASCAInt'})

h=figure; hold on
for factor=1:3
    plot(-log10(parglmoVS.p(parglmoVS.ordFactors(factor,:),factor)))
end
plot(-log10(parglmoVS.p(parglmoVS.ordInteractions(1,:),4)))
plot([1 size(X2,2)],-log10([pvalue pvalue]),'rREPLACE_WITH_DASH_DASH')
legend('Factor LFR/Ctrl','Factor Time','Factor Individual','LFR/Ctrl x Time','\alpha=0.05','Location','south')
a=get(h,'CurrentAxes');
set(a,'FontSize',14)
set(a,'YScale','log')
ylabel('-log_{10}(p-value)','FontSize',18)
xlabel('Variables in selected order','FontSize',18)
title('Manhattan Plot vASCA')
axis tight

saveas(gcf,'Figures/FigManhattan_bb');
saveas(gcf,'Figures/FigManhattan_bb.jpg','jpg');
saveas(gcf,'Figures/FigManhattan_bb.png','png');


%% Display results: VASCA

vascao = vasca(parglmoVS, pvalue);


% LFR/Ctrl factor

i=1;
if isfield(vascao.factors{i},'scores')

    TvASCA = table((1:length(vascao.factors{i}.ind))',var_l2(sort(vascao.factors{i}.ind))', vascao.p(sort(vascao.factors{i}.ind),i),'VariableNames', {'Order','Label',sprintf('PvalueF%i',i)})
    
    scores(vascao.factors{i}, 'Title', 'Case/control', 'ObsClass', vascao.design(:,i));
    legend('Control', 'LFG');

    if length(vascao.factors{i}.ind)==1
        ylabel(var_l2(vascao.factors{i}.ind))
    else
        loadings(vascao.factors{i}, 'Title','Case/control','VarsLabel', var_l2(sort(vascao.factors{i}.ind)));
    end

end


% Time Factor

i=2;
if isfield(vascao.factors{i},'scores')

    TvASCA = table((1:length(vascao.factors{i}.ind))',var_l2(sort(vascao.factors{i}.ind))', vascao.p(sort(vascao.factors{i}.ind),i),'VariableNames', {'Order','Label',sprintf('PvalueF%i',i)})
    
    vascao.factors{i}.loads = -vascao.factors{i}.loads;
    vascao.factors{i}.scoresV = -vascao.factors{i}.scoresV;
    
    scores(vascao.factors{i}, 'Title', 'Time', 'ObsClass',vascao.design(:,i));
    legend('T3', 'Labour');

    if length(vascao.factors{i}.ind)==1
        ylabel(var_l2(vascao.factors{i}.ind))
    else
        loadings(vascao.factors{i}, 'Title','Time', 'VarsLabel', var_l2(sort(vascao.factors{i}.ind))); 
    end
    
end


% Factor Individual
    
i=3;
if isfield(vascao.factors{i},'scores')

    TvASCA = table((1:length(vascao.factors{i}.ind))',var_l2(sort(vascao.factors{i}.ind))', vascao.p(sort(vascao.factors{i}.ind),i),'VariableNames', {'Order','Label',sprintf('PvalueF%i',i)})
    
    if vascao.factors{i}.stasig
        varPca(vascao.factors{i}.matrix);
        mspcPca(vascao.factors{i}.matrix, 'PCs', 1:2, 'ObsTest', vascao.factors{i}.matrix+vascao.residuals, 'PlotCal', false, 'ObsLabel', vascao.design(:,3), 'ObsClass', vascao.design(:,1), 'LimType', 1);
        title(sprintf('Factor %d',i));
        legend('Control', 'LFG');

    end
end


% 'Case/control' x 'Time'

i=1;
if isfield(vascao.interactions{i},'scores')

    TvASCA = table((1:length(vascao.interactions{i}.ind))',var_l2(sort(vascao.interactions{i}.ind))', vascao.p(sort(vascao.interactions{i}.ind),3+i),'VariableNames', {'Order','Label',sprintf('PvalueI%i',i)})
    
    scores(vascao.interactions{i}, 'Title', 'Int LFR/Ctrl x Time', 'ObsClass', vascao.design(:,1)*10+vascao.design(:,2));
    legend('Ctrl+T3','Case+T3','Ctrl+Labour','Case+Labour');

    if length(vascao.interactions{i}.ind)==1
        ylabel(var_l2(vascao.interactions{i}.ind))
    else
        loadings(model,'Title', 'Int LFR/Ctrl x Time', 'VarsLabel', var_l2(sort(vascao.interactions{i}.ind))); 
    end
    
end

%% Selection of loadings

indS = find(abs(vascao.factors{1}.loads)>0.2);
ind2 = sort(vascao.factors{i}.ind);
plotVec(vascao.factors{1}.loads(indS),'EleLabel', var_l2(ind2(indS)));
title('Case/control: Highest loadings')

saveas(gcf,'Figures/FigHL_bb');
saveas(gcf,'Figures/FigHL_bb.jpg','jpg');
saveas(gcf,'Figures/FigHL_bb.png','png');
##### SOURCE END #####
-->
</body>
</html>
